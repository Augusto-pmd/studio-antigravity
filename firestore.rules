/**
 * This Firestore Security Ruleset is designed for the PMD Manager application.
 *
 * Core Philosophy: This ruleset employs a hybrid security model. It combines a
 * strict user-ownership model for personal data with a collaborative, role-based
 * model for shared project data. The default security posture is to deny all
 * access, granting permissions explicitly. All operations require user authentication.
 *
 * Data Structure: The data is organized into logical, top-level collections.
 * - /users/{userId}: Contains user-specific profiles and private subcollections
 *   like 'cashAccount'. Access is strictly limited to the document owner.
 * - /projects/{projectId}: Contains shared project data. Access is managed by
 *   a denormalized 'members' map within each project document. Subcollections
 *   like 'expenses' and 'contracts' inherit access from their parent project.
 * - /suppliers/{supplierId}: A globally readable collection of supplier information.
 *   Writes are restricted to administrative users.
 *
 * Key Security Decisions:
 * - Admin Roles: A global admin role is derived from the 'role' field in a user's
 *   profile (`/users/{userId}`). Users with roles like 'Dirección' or 'Administración'
 *   are granted elevated privileges for managing shared resources.
 * - No User Listing: To protect user privacy, listing all documents in the '/users'
 *   collection is forbidden for non-administrative users.
 * - Denormalization for Authorization: Project documents are expected to contain
 *   a `members` map (e.g., `{ members: { 'user_uid_1': 'admin', 'user_uid_2': 'viewer' } }`).
 *   This avoids slow and costly `get()` calls in most list queries and allows for
 *   performant, secure access control for all project-related data.
 * - Relational Integrity: On document creation, rules validate that key identifiers
 *   (e.g., `userId`, `projectId`) are correctly set in the document body to match
 *   the document's path, ensuring data consistency. These identifiers are then
 *   enforced as immutable on updates.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document being accessed already exists.
     * Used to protect against updates or deletes on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * A convenient combination of isOwner and isExistingDoc for update/delete rules.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    /**
     * Checks if the user has the 'Dirección' role.
     * WARNING: This function uses a get() operation. This will be evaluated
     * for every document in a list query, which can impact performance and cost.
     * It is used here to grant the Director role full access as requested.
     */
    function isDirector() {
      return isSignedIn() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Dirección';
    }
    
    /**
     * Checks if the user is an admin. An admin is a user with the 'Dirección'
     * or 'Administración' role.
     * WARNING: This uses get() and can impact performance on list queries.
     */
    function isAdmin() {
      return isSignedIn() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Dirección', 'Administración'];
    }
    
    function isSupervisorOrAdmin() {
      return isSignedIn() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Dirección', 'Administración', 'Supervisor'];
    }

    function isPañoleroOrAdmin() {
      return isSignedIn() &&
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Dirección', 'Administración', 'Supervisor', 'Pañolero'];
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user profiles. Only the user themselves can create, update, or
     * delete their own profile. Admins are granted read-only access.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isExistingOwner(userId) || isDirector();
      
      /**
       * @description Manages a user's cash accounts and their transactions.
       * A user can manage their own accounts. Admins have oversight.
       * @path /users/{userId}/cashAccounts/{cashAccountId}
       */
      match /cashAccounts/{cashAccountId} {
        allow read, write: if isOwner(userId) || isAdmin();

        /**
        * @description Manages transactions within a specific cash account.
        * @path /users/{userId}/cashAccounts/{cashAccountId}/transactions/{transactionId}
        */
        match /transactions/{transactionId} {
          allow read, write: if isOwner(userId) || isAdmin();
        }
      }
    }

    match /projects/{projectId} {
      allow read, write: if isSignedIn();
      match /expenses/{expenseId} {
        allow read, write: if isSignedIn();
      }
      match /contracts/{contractId} {
        allow read, write: if isSignedIn();
      }
    }

    match /suppliers/{supplierId} {
      allow read, write: if isSignedIn();
    }
    
    match /employees/{employeeId} {
      allow read, write: if isSignedIn();
    }
    
    match /technicalOfficeEmployees/{employeeId} {
      allow read, write: if isAdmin();
      match /salaryHistory/{salaryHistoryId} {
        allow read, write: if isAdmin();
      }
    }

    match /monthlySalaries/{salaryId} {
      allow read, write: if isAdmin();
    }
    
    match /timeLogs/{logId} {
      allow read, create, update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow list: if isAdmin() || (isSignedIn() && request.query.where[0][2] == request.auth.uid);
      allow delete: if isAdmin() || (isExistingDoc() && resource.data.userId == request.auth.uid);
    }

    match /contractors/{contractorId} {
      allow read, write: if isSignedIn();
      match /personnel/{personnelId} {
        allow read, write: if isSignedIn();
      }
    }
    
    match /assets/{assetId} {
      allow read, write: if isSignedIn();
    }
    
    match /fundRequests/{fundRequestId} {
      allow read, write: if isSignedIn();
    }

    match /payrollWeeks/{payrollWeekId} {
      allow read, write: if isSignedIn();
    }

    match /taskRequests/{taskRequestId} {
      allow read, write: if isSignedIn();
    }
    
    match /cashAdvances/{cashAdvanceId} {
      allow read, write: if isSignedIn();
    }

    match /attendances/{attendanceId} {
      allow read, write: if isSupervisorOrAdmin();
    }

    match /treasuryAccounts/{treasuryAccountId} {
      allow read, write: if isAdmin();
      match /transactions/{transactionId} {
        allow read, write: if isAdmin();
      }
    }
    
    match /recurringExpenses/{expenseId} {
        allow read, write: if isAdmin();
    }

    match /moratorias/{moratoriaId} {
      allow read, write: if isAdmin();
    }

    match /stockItems/{itemId} {
      allow read: if isSignedIn();
      allow write: if isPañoleroOrAdmin();
      
      match /movements/{movementId} {
        allow read: if isSignedIn();
        allow write: if isPañoleroOrAdmin();
      }
    }

    match /{path=**}/expenses/{expenseId} {
      allow get, list: if isSignedIn();
    }
  }
}
