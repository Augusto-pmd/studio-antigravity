/**
 * Core Philosophy: This ruleset implements a hybrid security model designed for a project management application.
 * It enforces strict user ownership for personal data while providing a secure foundation for project-related and master data.
 * The primary goal is strong authorization during prototyping, with flexibility in data schemas.
 *
 * Data Structure:
 * - /user-profiles/{userProfileId}/*: All data directly related to a specific application user (profile, cash accounts) is nested under their unique user ID.
 * - /projects/{projectId}/*: Project-specific data (details, expenses, contracts) is organized under a unique project ID.
 * - /employees, /suppliers, /categories: Top-level collections for master data.
 * - /attendances, /cash-advances: Top-level collections for transactional data.
 *
 * Key Security Decisions:
 * - User Data Segregation: All documents and subcollections under /user-profiles/{userProfileId} are strictly private and can only be accessed by the authenticated owner.
 * - Project Data Lockdown: The `Project` entity and its subcollections currently lack an `ownerId` or `members` field. To maintain security, all write operations on projects and their sub-data are disabled. Reads are permitted for any signed-in user.
 * - Master & Transactional Data is Read-Only: Collections like `suppliers`, `categories`, `employees`, `attendances`, and `cash-advances` are treated as read-only for application users. This prevents unauthorized modification of shared application data until role-based security is implemented.
 * - Default Deny: Any access not explicitly granted is denied.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userProfileId.
     * This is the primary function for enforcing document ownership for app users.
     */
    function isOwner(userProfileId) {
      return isSignedIn() && request.auth.uid == userProfileId;
    }

    /**
     * Returns true if a parent project document exists. Used to secure access
     * to project subcollections.
     */
    function projectExists(projectId) {
      return exists(/databases/$(database)/documents/projects/$(projectId));
    }

    // ----------------------------------------------------------------------
    // Application User Data Rules
    // ----------------------------------------------------------------------

    match /user-profiles/{userProfileId} {
      allow get: if isOwner(userProfileId);
      allow list: if false; // Prevent listing all users for privacy
      allow create: if isOwner(userProfileId);
      allow update, delete: if isOwner(userProfileId);

      // --- Subcollections ---
      match /cash/{cashId} {
        allow read, write: if isOwner(userProfileId);
      }
    }

    // ----------------------------------------------------------------------
    // Project Data Rules
    // ----------------------------------------------------------------------

    match /projects/{projectId} {
      allow get, list: if isSignedIn();
      // CRITICAL: Writes are disabled. The 'Project' entity lacks an `ownerId` or `members` field.
      // This is a secure default. Enable writes only after adding an ownership field to the schema.
      allow write: if false;

      // --- Subcollections ---
      match /expenses/{expenseId} {
        allow get, list: if isSignedIn() && projectExists(projectId);
        // Allow writes for any signed-in user to enable expense tracking during prototyping.
        allow write: if isSignedIn();
      }

      match /contracts/{contractId} {
        allow get, list: if isSignedIn() && projectExists(projectId);
         // CRITICAL: Write access depends on parent project ownership, which isn't defined.
        allow write: if false;
      }
    }

    // ----------------------------------------------------------------------
    // Master & Transactional Data Rules
    // ----------------------------------------------------------------------

    match /suppliers/{supplierId} {
      allow get, list: if isSignedIn();
      // Allow create, update, delete for any signed-in user for prototyping.
      allow write: if isSignedIn();
    }
    
    match /contractors/{contractorId} {
      allow get, list: if isSignedIn();
      // Allow create, update, delete for any signed-in user for prototyping.
      allow write: if isSignedIn();

      // --- Subcollections ---
      match /employees/{employeeId} {
        allow get, list: if isSignedIn() && exists(/databases/$(database)/documents/contractors/$(contractorId));
        // Allow writes for signed-in users to manage personnel lists.
        allow write: if isSignedIn();
      }
    }

    match /categories/{categoryId} {
      allow get, list: if isSignedIn();
       // Master data should not be modifiable by clients.
      allow write: if false;
    }

    match /employees/{employeeId} {
      allow get, list: if isSignedIn();
      // Allow create, update, delete for any signed-in user for prototyping.
      allow write: if isSignedIn();
    }

    match /attendances/{attendanceId} {
      allow get, list: if isSignedIn();
      // CRITICAL: Transactional data should only be written by authorized roles.
      allow write: if false;
    }

    match /cash-advances/{cashAdvanceId} {
      allow get, list: if isSignedIn();
      // CRITICAL: Transactional data should only be written by authorized roles.
      allow write: if false;
    }

    match /task-requests/{taskRequestId} {
      allow create: if isSignedIn();

      // Allow reading a single task if you created it or are assigned to it.
      allow get: if isSignedIn() && (resource.data.requesterId == request.auth.uid || resource.data.assigneeId == request.auth.uid);

      // Allow list for any signed-in user. The UI must filter.
      allow list: if isSignedIn();

      // The assignee can mark the task as "Finalizado"
      allow update: if isSignedIn() &&
                 request.auth.uid == resource.data.assigneeId &&
                 request.resource.data.status == 'Finalizado' &&
                 resource.data.status == 'Pendiente' &&
                 request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completedAt']);

      allow delete: if false; // To preserve history, don't allow deletes.
    }
  }
}

    